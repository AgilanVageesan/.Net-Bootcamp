# RequestResponseLogging Middleware

Middleware in ASP.NET Core allows you to handle HTTP requests and responses at various stages of the request processing pipeline. It provides a way to intercept, inspect, and modify requests and responses before they reach the endpoint or after they are generated by the endpoint.

In this project, we'll create a custom RequestResponseLogging Middleware to log incoming HTTP requests and outgoing HTTP responses, including their details such as method, path, query string, request body, status code, and response body. This logging middleware will provide valuable information for monitoring and debugging purposes.

## Steps to Create RequestResponseLogging Middleware

1. Create a new class called `RequestResponseLoggingMiddleware.cs`:

```csharp
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System;
using System.IO;
using System.Text;
using System.Threading.Tasks;

public class RequestResponseLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger _logger;

    public RequestResponseLoggingMiddleware(RequestDelegate next, ILogger<RequestResponseLoggingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task Invoke(HttpContext context)
    {
        // Enable buffering for the request body, if needed
        context.Request.EnableBuffering();

        // Log the incoming request
        _logger.LogInformation(await FormatRequest(context.Request));

        // Capture the response
        var originalBodyStream = context.Response.Body;

        using (var responseBody = new MemoryStream())
        {
            context.Response.Body = responseBody;

            // Continue processing the request
            await _next(context);

            // Log the outgoing response
            _logger.LogInformation(await FormatResponse(context.Response));

            // Copy the response body to the original stream and flush
            await responseBody.CopyToAsync(originalBodyStream);
        }
    }

    private async Task<string> FormatRequest(HttpRequest request)
    {
        request.EnableBuffering();

        var body = request.Body;
        var buffer = new byte[Convert.ToInt32(request.ContentLength)];
        await request.Body.ReadAsync(buffer, 0, buffer.Length);
        var bodyAsText = Encoding.UTF8.GetString(buffer);
        request.Body.Seek(0, SeekOrigin.Begin);

        return $"Request Method: {request.Method}, Path: {request.Path}, Query String: {request.QueryString}, Body: {bodyAsText}";
    }

    private async Task<string> FormatResponse(HttpResponse response)
    {
        response.Body.Seek(0, SeekOrigin.Begin);
        var text = await new StreamReader(response.Body).ReadToEndAsync();
        response.Body.Seek(0, SeekOrigin.Begin);

        return $"Response Status: {response.StatusCode}, Body: {text}";
    }
}
```

2. Register the Middleware in `Startup.cs`:

In the `Startup.cs` file, register the `RequestResponseLoggingMiddleware` in the `Configure` method before calling `UseRouting()`:

```csharp
using Microsoft.AspNetCore.Builder;
using Microsoft.Extensions.DependencyInjection;

public class Startup
{
    // Other configurations...

    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
    {
        // Enable the custom logging middleware
        app.UseMiddleware<RequestResponseLoggingMiddleware>();

        // Middleware and endpoints configurations...
    }
}
```

## How Middleware Works in ASP.NET Core

Middleware in ASP.NET Core is a chain of components that handle HTTP requests and responses. The middleware pipeline starts at the server and goes through a series of middleware components, and then back to the server. Each middleware component can process the request, modify the response, or pass the request to the next middleware in the pipeline.

Middleware components are executed in the order they are added to the pipeline using the `Use` extension methods in the `Configure` method of the `Startup` class. The `Use` methods build the request processing pipeline.

In the context of our `RequestResponseLoggingMiddleware`, it gets executed for every incoming HTTP request. It logs the request details, continues processing the request to reach the endpoint, and then logs the response details.

By adding custom middleware like `RequestResponseLoggingMiddleware`, you can implement cross-cutting concerns, such as logging, authentication, and exception handling, in a reusable and non-intrusive way, making your application more modular and maintainable.
